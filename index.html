<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autonomic Drugs Flip-Card Quiz</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --bg-color: #f0f4f8;
            --card-bg: #ffffff;
            --primary-text: #1e293b;
            --secondary-text: #475569;
            --accent-color: #3b82f6;
            --accent-hover: #2563eb;
            --border-color: #e2e8f0;
            --correct-bg: #dcfce7;
            --correct-text: #166534;
            --incorrect-bg: #fee2e2;
            --incorrect-text: #991b1b;
            --missed-bg: #ffedd5;
            --missed-text: #9a3412;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --font-family: 'Inter', sans-serif;
        }

        /* Basic Setup */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--primary-text);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 2rem 1rem;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            width: 100%;
            max-width: 700px;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* Header */
        header {
            background-color: var(--card-bg);
            border-radius: 0.75rem;
            padding: 1rem 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header-group {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .header-group .label {
            font-weight: 500;
            color: var(--secondary-text);
            font-size: 0.875rem;
        }

        #scoreboard {
            font-weight: 600;
            font-size: 1.125rem;
            background-color: var(--bg-color);
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
        }

        /* Toggle Switches */
        .toggle-switch {
            display: flex;
            background-color: var(--bg-color);
            border-radius: 999px;
            padding: 0.25rem;
            border: 1px solid var(--border-color);
        }

        .toggle-switch button {
            border: none;
            background-color: transparent;
            padding: 0.375rem 0.875rem;
            border-radius: 999px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.875rem;
            color: var(--secondary-text);
            transition: all 0.2s ease-in-out;
        }

        .toggle-switch button.active {
            background-color: var(--card-bg);
            color: var(--primary-text);
            box-shadow: 0 1px 3px rgb(0 0 0 / 0.1);
        }

        /* Flip Card */
        .flip-card {
            background-color: transparent;
            perspective: 1000px;
        }

        .flip-card-inner {
            position: relative;
            width: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }

        .flip-card.is-flipped .flip-card-inner {
            transform: rotateY(180deg);
        }

        .card-face {
            position: absolute;
            width: 100%;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            background-color: var(--card-bg);
            border-radius: 0.75rem;
            padding: 2rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .card-back {
            transform: rotateY(180deg);
        }

        /* Card Content */
        #drug-name-front, #drug-name-back {
            font-size: 2.25rem;
            font-weight: 700;
            margin-bottom: 2rem;
            text-align: center;
            color: var(--accent-color);
        }
        
        .quiz-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 150px 1fr;
            align-items: center;
            gap: 1rem;
        }

        .form-row label {
            font-weight: 600;
            text-align: right;
            color: var(--secondary-text);
        }

        .input-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }
        
        #receptors-group {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
        }

        /* Custom Radio/Checkbox */
        .choice-input {
            display: none;
        }

        .choice-label {
            display: inline-block;
            padding: 0.5rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            font-weight: 500;
            width: 100%;
            text-align: center;
        }

        .choice-input:checked + .choice-label {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }
        
        .choice-input:hover:not(:checked) + .choice-label {
            border-color: var(--accent-hover);
        }
        
        #indirect-mechanisms-container {
            padding: 1rem;
            background: #f8fafc;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
            border: 1px solid var(--border-color);
        }

        .receptor-details {
             display: flex;
             align-items: center;
             gap: 0.5rem;
             margin-left: 1rem;
             font-size: 0.8rem;
        }
        
        .receptor-details .toggle-switch {
            font-size: 0.75rem;
        }
        .receptor-details .toggle-switch button {
             padding: 0.25rem 0.5rem;
             font-size: 0.75rem;
        }

        /* Buttons */
        .button-group {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 2rem;
        }

        .btn {
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }

        .btn-primary {
            background-color: var(--accent-color);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--accent-hover);
        }

        .btn-secondary {
            background-color: transparent;
            color: var(--secondary-text);
            border: 2px solid var(--border-color);
        }
        .btn-secondary:hover {
            background-color: var(--bg-color);
            border-color: var(--secondary-text);
        }

        /* Card Back Feedback */
        .feedback-section { display: flex; flex-direction: column; gap: 1.25rem; }
        .feedback-row {
            display: grid;
            grid-template-columns: 150px 1fr;
            align-items: start;
            gap: 1rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
        }
        .feedback-row.correct { background-color: var(--correct-bg); color: var(--correct-text); }
        .feedback-row.incorrect { background-color: var(--incorrect-bg); color: var(--incorrect-text); }
        
        .feedback-row .label { font-weight: 600; text-align: right; }
        .feedback-row .value { font-weight: 500; }
        .feedback-chips { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .chip { padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.875rem; font-weight: 500; }
        .chip.correct { background-color: var(--correct-text); color: white; }
        .chip.incorrect { background-color: var(--incorrect-text); color: white; }
        .chip.missed { background-color: var(--missed-text); color: white; }

        .explanation {
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: var(--bg-color);
            border-radius: 0.5rem;
            border-left: 4px solid var(--accent-color);
        }
        .explanation p { color: var(--secondary-text); line-height: 1.6; }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease-in-out;
        }
        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--card-bg);
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            text-align: center;
            max-width: 400px;
            transform: scale(0.95);
            transition: transform 0.3s ease-in-out;
        }
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }

        .modal-content h2 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }
        .modal-content p {
            color: var(--secondary-text);
            margin-bottom: 2rem;
        }
        .modal-content .button-group {
            justify-content: center;
        }

        /* Utility */
        .hidden { display: none !important; }

        @media (max-width: 600px) {
            body { padding: 1rem 0.5rem; }
            .container { gap: 1rem; }
            header { flex-direction: column; align-items: stretch; gap: 1rem; }
            .header-group { justify-content: space-between;}
            .card-face { padding: 1.5rem; }
            #drug-name-front, #drug-name-back { font-size: 1.75rem; margin-bottom: 1.5rem; }
            #receptors-group {
                grid-template-columns: repeat(2, 1fr);
            }
            .form-row, .feedback-row { grid-template-columns: 1fr; gap: 0.5rem; }
            .form-row label, .feedback-row .label { text-align: left; margin-bottom: 0.5rem; }
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- Header -->
        <header>
            <div class="header-group">
                <span class="label">Mode:</span>
                <div id="mode-toggle" class="toggle-switch">
                    <button data-mode="minimal" class="active">Minimal</button>
                    <button data-mode="advanced">Advanced</button>
                </div>
            </div>
            <div class="header-group">
                <span class="label">Session:</span>
                <div id="session-toggle" class="toggle-switch">
                    <button data-session="study" class="active">Study</button>
                    <button data-session="test">Test</button>
                </div>
            </div>
            <div class="header-group">
                <span class="label">Progress:</span>
                <div id="scoreboard">0 / 0</div>
            </div>
        </header>

        <!-- Flip Card -->
        <div id="flip-card" class="flip-card">
            <div class="flip-card-inner">
                <!-- Card Front (Question) -->
                <div class="card-face card-front">
                    <h2 id="drug-name-front">Drug Name</h2>
                    <form id="quiz-form" class="quiz-form">
                        <!-- Pathway -->
                        <div class="form-row">
                            <label for="pathway">Pathway</label>
                            <div class="input-group" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem;">
                                <input type="radio" id="path-symp" name="pathway" value="sympathetic" class="choice-input">
                                <label for="path-symp" class="choice-label">Sympathetic</label>
                                <input type="radio" id="path-para" name="pathway" value="parasympathetic" class="choice-input">
                                <label for="path-para" class="choice-label">Parasympathetic</label>
                                <input type="radio" id="path-gang" name="pathway" value="ganglionic" class="choice-input">
                                <label for="path-gang" class="choice-label">Ganglionic/NMJ</label>
                            </div>
                        </div>

                        <!-- Action Path -->
                        <div class="form-row">
                            <label>Action Path</label>
                            <div class="input-group">
                                <input type="checkbox" id="action-direct" name="actionPath" value="direct" class="choice-input">
                                <label for="action-direct" class="choice-label">Direct</label>
                                <input type="checkbox" id="action-indirect" name="actionPath" value="indirect" class="choice-input">
                                <label for="action-indirect" class="choice-label">Indirect</label>
                            </div>
                        </div>
                        
                        <!-- Indirect Mechanisms -->
                        <div id="indirect-mechanisms-container" class="hidden">
                             <div class="form-row">
                                 <label>Indirect Mechanisms</label>
                                 <div class="input-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                                     <input type="checkbox" id="mech-release" name="indirectMechanism" value="Release" class="choice-input"><label for="mech-release" class="choice-label">Release</label>
                                     <input type="checkbox" id="mech-reuptake" name="indirectMechanism" value="Reuptake inhibition" class="choice-input"><label for="mech-reuptake" class="choice-label">Reuptake Inhibition</label>
                                     <input type="checkbox" id="mech-mao" name="indirectMechanism" value="MAO inhibition" class="choice-input"><label for="mech-mao" class="choice-label">MAO Inhibition</label>
                                     <input type="checkbox" id="mech-comt" name="indirectMechanism" value="COMT inhibition" class="choice-input"><label for="mech-comt" class="choice-label">COMT Inhibition</label>
                                     <input type="checkbox" id="mech-ache" name="indirectMechanism" value="AChE inhibition" class="choice-input"><label for="mech-ache" class="choice-label">AChE Inhibition</label>
                                     <input type="checkbox" id="mech-other" name="indirectMechanism" value="Other" class="choice-input"><label for="mech-other" class="choice-label">Other</label>
                                 </div>
                             </div>
                        </div>

                        <!-- Agonism -->
                        <div class="form-row">
                            <label>Agonism</label>
                            <div class="input-group">
                                <input type="radio" id="agonism-agonist" name="agonism" value="agonist" class="choice-input">
                                <label for="agonism-agonist" class="choice-label">Agonist</label>
                                <input type="radio" id="agonism-antagonist" name="agonism" value="antagonist" class="choice-input">
                                <label for="agonism-antagonist" class="choice-label">Antagonist</label>
                            </div>
                        </div>

                        <!-- Net Tilt -->
                        <div class="form-row">
                            <label>Net Tilt</label>
                            <div class="input-group" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem;">
                                <input type="radio" id="tilt-fight" name="tilt" value="fight" class="choice-input">
                                <label for="tilt-fight" class="choice-label">Fight-or-Flight</label>
                                <input type="radio" id="tilt-rest" name="tilt" value="rest" class="choice-input">
                                <label for="tilt-rest" class="choice-label">Rest-and-Digest</label>
                                <input type="radio" id="tilt-variable" name="tilt" value="variable" class="choice-input">
                                <label for="tilt-variable" class="choice-label">Variable</label>
                            </div>
                        </div>
                        
                        <!-- Receptors -->
                        <div class="form-row">
                            <label>Receptors</label>
                            <div id="receptors-group" class="input-group">
                                <!-- Receptors will be populated by JS -->
                            </div>
                        </div>
                        
                        <div class="button-group">
                            <button type="button" id="reset-btn" class="btn btn-secondary">Reset</button>
                            <button type="submit" id="submit-btn" class="btn btn-primary">Submit</button>
                        </div>
                    </form>
                </div>
                <!-- Card Back (Answer) -->
                <div class="card-face card-back">
                    <h2 id="drug-name-back">Drug Name</h2>
                    <div id="feedback-section" class="feedback-section">
                        <!-- Feedback rows will be populated by JS -->
                    </div>
                    <div id="explanation" class="explanation hidden">
                        <p id="explanation-text"></p>
                    </div>
                    <div class="button-group">
                        <button type="button" id="back-btn" class="btn btn-secondary">Back to Front</button>
                        <button type="button" id="next-btn" class="btn btn-primary">Next</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Mode Chooser Modal -->
    <div id="mode-chooser-modal" class="modal-overlay visible">
        <div class="modal-content">
            <h2>Choose Your Quiz Mode</h2>
            <p>Select a mode to begin. You can change this at any time using the settings in the header.</p>
            <div class="button-group">
                <button id="choose-minimal" class="btn btn-secondary">Minimal</button>
                <button id="choose-advanced" class="btn btn-primary">Advanced</button>
            </div>
        </div>
    </div>

    <!-- Test Results Modal -->
    <div id="test-results-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Test Round Complete</h2>
            <p>Here's a summary of the concepts you missed. Review them and start the next round!</p>
            <div id="test-results-content" style="text-align: left; max-height: 300px; overflow-y: auto; margin-bottom: 1.5rem; font-size: 0.9rem;"></div>
            <button id="close-results-btn" class="btn btn-primary">Continue</button>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- DATA MODEL --- //
            const masterDrugList = [
                // --- SYMPATHOMIMETICS (Direct-Acting Agonists) ---
                { name: "Phenylephrine (Neo-Synephrine)", tone: "sympathetic", agonism: "agonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["alpha-1"], receptorMap: { "alpha-1": { mode: "direct" } }, explanation: "A pure alpha-1 adrenergic agonist that causes potent vasoconstriction." },
                { name: "Midodrine (Proamatine)", tone: "sympathetic", agonism: "agonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["alpha-1"], receptorMap: { "alpha-1": { mode: "direct" } }, explanation: "An orally active alpha-1 agonist prodrug used to treat symptomatic orthostatic hypotension." },
                { name: "Norepinephrine (Levophed)", tone: "sympathetic", agonism: "agonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["alpha-1", "alpha-2", "beta-1"], receptorMap: { "alpha-1": { mode: "direct" }, "alpha-2": { mode: "direct" }, "beta-1": { mode: "direct" } }, explanation: "Potent alpha-1/beta-1 agonist, causing strong vasoconstriction and increased cardiac contractility with less effect on heart rate." },
                { name: "Epinephrine (Adrenaline)", tone: "sympathetic", agonism: "agonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["alpha-1", "alpha-2", "beta-1", "beta-2"], receptorMap: { "alpha-1": { mode: "direct" }, "alpha-2": { mode: "direct" }, "beta-1": { mode: "direct" }, "beta-2": { mode: "direct" } }, explanation: "Acts on all adrenergic receptors; key for anaphylaxis due to vasoconstriction (alpha-1), cardiac effects (beta-1), and bronchodilation (beta-2)." },
                { name: "Dopamine", tone: "sympathetic", agonism: "agonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["alpha-1", "beta-1"], receptorMap: { "alpha-1": { mode: "direct" }, "beta-1": { mode: "direct" } }, explanation: "Dose-dependent effects: intermediate doses stimulate beta-1 (inotropic), and high doses stimulate alpha-1 (vasoconstriction)." },
                { name: "Dobutamine", tone: "sympathetic", agonism: "agonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["beta-1"], receptorMap: { "beta-1": { mode: "direct" } }, explanation: "Primarily a beta-1 agonist, increasing cardiac contractility (inotropic) more than heart rate (chronotropic)." },
                { name: "Isoproterenol", tone: "sympathetic", agonism: "agonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["beta-1", "beta-2"], receptorMap: { "beta-1": { mode: "direct" }, "beta-2": { mode: "direct" } }, explanation: "A potent non-selective beta-agonist. Causes significant increases in heart rate/contractility (beta-1) and vasodilation/bronchodilation (beta-2)." },
                { name: "Albuterol (Ventolin)", tone: "sympathetic", agonism: "agonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["beta-2"], receptorMap: { "beta-2": { mode: "direct" } }, explanation: "A selective short-acting beta-2 agonist (SABA) for acute bronchodilation." },
                { name: "Levalbuterol (Xopenex)", tone: "sympathetic", agonism: "agonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["beta-2"], receptorMap: { "beta-2": { mode: "direct" } }, explanation: "The R-enantiomer of albuterol, a selective SABA for bronchodilation." },
                { name: "Terbutaline", tone: "sympathetic", agonism: "agonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["beta-2"], receptorMap: { "beta-2": { mode: "direct" } }, explanation: "A selective beta-2 agonist used for bronchodilation and tocolysis (relaxation of the uterus)." },
                { name: "Salmeterol (Serevent)", tone: "sympathetic", agonism: "agonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["beta-2"], receptorMap: { "beta-2": { mode: "direct" } }, explanation: "A long-acting beta-2 agonist (LABA) for maintenance bronchodilation." },
                { name: "Formoterol (Performist)", tone: "sympathetic", agonism: "agonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["beta-2"], receptorMap: { "beta-2": { mode: "direct" } }, explanation: "A long-acting beta-2 agonist (LABA) with a faster onset of action than salmeterol." },
                { name: "Aformoterol (Brovana)", tone: "sympathetic", agonism: "agonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["beta-2"], receptorMap: { "beta-2": { mode: "direct" } }, explanation: "The R-enantiomer of formoterol, a long-acting beta-2 agonist (LABA)." },
                { name: "Indacaterol (Arcapta)", tone: "sympathetic", agonism: "agonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["beta-2"], receptorMap: { "beta-2": { mode: "direct" } }, explanation: "An ultra-long-acting beta-2 agonist (ultra-LABA) for once-daily COPD maintenance." },
                { name: "Olodaterol (Striverdi)", tone: "sympathetic", agonism: "agonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["beta-2"], receptorMap: { "beta-2": { mode: "direct" } }, explanation: "An ultra-long-acting beta-2 agonist (ultra-LABA) for once-daily COPD maintenance." },
                { name: "Vilanterol", tone: "sympathetic", agonism: "agonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["beta-2"], receptorMap: { "beta-2": { mode: "direct" } }, explanation: "An ultra-long-acting beta-2 agonist (ultra-LABA), available only in combination inhalers." },
                { name: "Mirabegron (Myrbetriq)", tone: "sympathetic", agonism: "agonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["beta-3"], receptorMap: { "beta-3": { mode: "direct" } }, explanation: "A selective beta-3 agonist that relaxes the detrusor muscle to treat overactive bladder." },
                { name: "Vibegron (Gemtesa)", tone: "sympathetic", agonism: "agonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["beta-3"], receptorMap: { "beta-3": { mode: "direct" } }, explanation: "A selective beta-3 agonist used to treat overactive bladder." },
                { name: "Clonidine", tone: "sympathetic", agonism: "agonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["alpha-2"], receptorMap: { "alpha-2": { mode: "direct" } }, tiltOverride: "rest", explanation: "A centrally-acting alpha-2 agonist that reduces sympathetic outflow, causing hypotension and bradycardia (net sympatholytic effect)." },
                { name: "Dexmedetomidine (Precedex)", tone: "sympathetic", agonism: "agonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["alpha-2"], receptorMap: { "alpha-2": { mode: "direct" } }, tiltOverride: "rest", explanation: "A highly selective central alpha-2 agonist used for sedation and analgesia, reducing sympathetic tone." },
                { name: "Guanfacine", tone: "sympathetic", agonism: "agonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["alpha-2"], receptorMap: { "alpha-2": { mode: "direct" } }, tiltOverride: "rest", explanation: "A selective, centrally-acting alpha-2 agonist used for hypertension and ADHD." },
                { name: "Guanabenz", tone: "sympathetic", agonism: "agonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["alpha-2"], receptorMap: { "alpha-2": { mode: "direct" } }, tiltOverride: "rest", explanation: "A centrally-acting alpha-2 agonist that reduces sympathetic outflow, causing hypotension." },
                { name: "Alpha-Methyldopa", tone: "sympathetic", agonism: "agonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["alpha-2"], receptorMap: { "alpha-2": { mode: "direct" } }, tiltOverride: "rest", explanation: "A prodrug converted to a central alpha-2 agonist; used for hypertension in pregnancy." },
                { name: "Oxymetazoline", tone: "sympathetic", agonism: "agonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["alpha-1", "alpha-2"], receptorMap: { "alpha-1": { mode: "direct" }, "alpha-2": { mode: "direct" } }, explanation: "A direct-acting alpha agonist used as a topical nasal decongestant; can cause rebound congestion." },
                { name: "Naphazoline", tone: "sympathetic", agonism: "agonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["alpha-1", "alpha-2"], receptorMap: { "alpha-1": { mode: "direct" }, "alpha-2": { mode: "direct" } }, explanation: "A direct alpha agonist found in over-the-counter vasoconstrictor eye drops." },
                { name: "Xylometazoline", tone: "sympathetic", agonism: "agonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["alpha-1", "alpha-2"], receptorMap: { "alpha-1": { mode: "direct" }, "alpha-2": { mode: "direct" } }, explanation: "Topical alpha agonist used as a nasal decongestant, similar to oxymetazoline." },
                { name: "Tetrahydrozoline", tone: "sympathetic", agonism: "agonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["alpha-1", "alpha-2"], receptorMap: { "alpha-1": { mode: "direct" }, "alpha-2": { mode: "direct" } }, explanation: "Alpha agonist found in eye drops to relieve redness by causing vasoconstriction." },

                // --- SYMPATHOMIMETICS (Indirect/Mixed) ---
                { name: "Ephedrine", tone: "sympathetic", agonism: "agonist", actionPaths: ["direct", "indirect"], indirectMechanisms: ["Release"], receptors: ["alpha-1", "beta-1", "beta-2"], receptorMap: { "alpha-1": { mode: "indirect", mechanisms: ["Release"] }, "beta-1": { mode: "indirect", mechanisms: ["Release"] }, "beta-2": { mode: "direct" } }, explanation: "A mixed-acting agonist that directly stimulates beta receptors and causes the release of norepinephrine." },
                { name: "Pseudoephedrine", tone: "sympathetic", agonism: "agonist", actionPaths: ["direct", "indirect"], indirectMechanisms: ["Release"], receptors: ["alpha-1", "beta-1"], receptorMap: { "alpha-1": { mode: "indirect", mechanisms: ["Release"] }, "beta-1": { mode: "direct" } }, explanation: "A mixed-acting agonist used as a nasal decongestant, with fewer CNS effects than ephedrine." },
                { name: "Phenylpropanolamine", tone: "sympathetic", agonism: "agonist", actionPaths: ["direct", "indirect"], indirectMechanisms: ["Release"], receptors: ["alpha-1", "beta-1"], receptorMap: { "alpha-1": { mode: "indirect", mechanisms: ["Release"] }, "beta-1": { mode: "direct" } }, explanation: "Mixed-acting sympathomimetic, formerly used as a decongestant and anorectic." },
                { name: "Cocaine", tone: "sympathetic", agonism: "agonist", actionPaths: ["indirect"], indirectMechanisms: ["Reuptake inhibition"], receptors: ["alpha-1", "beta-1"], receptorMap: { "alpha-1": { mode: "indirect", mechanisms: ["Reuptake inhibition"] }, "beta-1": { mode: "indirect", mechanisms: ["Reuptake inhibition"] } }, explanation: "Blocks reuptake of norepinephrine, dopamine, and serotonin, causing potent sympathomimetic and CNS effects." },
                { name: "Amphetamine", tone: "sympathetic", agonism: "agonist", actionPaths: ["indirect"], indirectMechanisms: ["Release", "Reuptake inhibition"], receptors: ["alpha-1", "beta-1"], receptorMap: { "alpha-1": { mode: "indirect", mechanisms: ["Release", "Reuptake inhibition"] }, "beta-1": { mode: "indirect", mechanisms: ["Release", "Reuptake inhibition"] } }, explanation: "Promotes release and blocks reuptake of norepinephrine and dopamine, causing significant CNS stimulation." },
                { name: "Methamphetamine", tone: "sympathetic", agonism: "agonist", actionPaths: ["indirect"], indirectMechanisms: ["Release", "Reuptake inhibition"], receptors: ["alpha-1", "beta-1"], receptorMap: { "alpha-1": { mode: "indirect", mechanisms: ["Release", "Reuptake inhibition"] }, "beta-1": { mode: "indirect", mechanisms: ["Release", "Reuptake inhibition"] } }, explanation: "Potent CNS stimulant that strongly promotes release and blocks reuptake of dopamine and norepinephrine." },
                { name: "MDMA (Ecstasy)", tone: "sympathetic", agonism: "agonist", actionPaths: ["indirect"], indirectMechanisms: ["Release", "Reuptake inhibition"], receptors: ["alpha-1", "beta-1"], receptorMap: { "alpha-1": { mode: "indirect", mechanisms: ["Release", "Reuptake inhibition"] }, "beta-1": { mode: "indirect", mechanisms: ["Release", "Reuptake inhibition"] } }, explanation: "Indirect-acting sympathomimetic that primarily increases serotonin release but also affects dopamine and norepinephrine." },
                { name: "Methylphenidate (Ritalin)", tone: "sympathetic", agonism: "agonist", actionPaths: ["indirect"], indirectMechanisms: ["Reuptake inhibition"], receptors: ["alpha-1", "beta-1"], receptorMap: { "alpha-1": { mode: "indirect", mechanisms: ["Reuptake inhibition"] }, "beta-1": { mode: "indirect", mechanisms: ["Reuptake inhibition"] } }, explanation: "A CNS stimulant that primarily blocks the reuptake of dopamine and norepinephrine." },
                { name: "Tyramine", tone: "sympathetic", agonism: "agonist", actionPaths: ["indirect"], indirectMechanisms: ["Release"], receptors: ["alpha-1", "beta-1"], receptorMap: { "alpha-1": { mode: "indirect", mechanisms: ["Release"] }, "beta-1": { mode: "indirect", mechanisms: ["Release"] } }, explanation: "Found in fermented foods; promotes norepinephrine release. Can cause a hypertensive crisis in patients taking MAO inhibitors." },
                { name: "Ergotamine", tone: "sympathetic", agonism: "agonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["alpha-1"], receptorMap: { "alpha-1": { mode: "direct" } }, explanation: "Ergot alkaloid with complex effects, including potent alpha-1 mediated vasoconstriction. Used for migraines." },
                { name: "Methylergonovine", tone: "sympathetic", agonism: "agonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["alpha-1"], receptorMap: { "alpha-1": { mode: "direct" } }, explanation: "Ergot alkaloid used to cause uterine smooth muscle contraction (alpha-1 mediated) to prevent postpartum hemorrhage." },

                // --- SYMPATHOLYTICS (Adrenergic Antagonists) ---
                { name: "Phenoxybenzamine", tone: "sympathetic", agonism: "antagonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["alpha-1", "alpha-2"], receptorMap: { "alpha-1": { mode: "direct" }, "alpha-2": { mode: "direct" } }, explanation: "An irreversible, non-selective alpha-antagonist used to treat pheochromocytoma." },
                { name: "Phentolamine (Regitine)", tone: "sympathetic", agonism: "antagonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["alpha-1", "alpha-2"], receptorMap: { "alpha-1": { mode: "direct" }, "alpha-2": { mode: "direct" } }, explanation: "A reversible, competitive, non-selective alpha-antagonist for hypertensive crises." },
                { name: "Prazosin (Minipress)", tone: "sympathetic", agonism: "antagonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["alpha-1"], receptorMap: { "alpha-1": { mode: "direct" } }, explanation: "A selective alpha-1 antagonist for hypertension and BPH; can cause first-dose orthostatic hypotension." },
                { name: "Terazosin (Hytrin)", tone: "sympathetic", agonism: "antagonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["alpha-1"], receptorMap: { "alpha-1": { mode: "direct" } }, explanation: "A selective alpha-1 antagonist, similar to prazosin but with a longer half-life." },
                { name: "Doxazosin (Cardura)", tone: "sympathetic", agonism: "antagonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["alpha-1"], receptorMap: { "alpha-1": { mode: "direct" } }, explanation: "A long-acting selective alpha-1 antagonist for hypertension and BPH." },
                { name: "Tamsulosin (Flomax)", tone: "sympathetic", agonism: "antagonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["alpha-1"], receptorMap: { "alpha-1": { mode: "direct" } }, explanation: "A selective alpha-1A antagonist, primarily used for benign prostatic hyperplasia (BPH) with less effect on blood pressure." },
                { name: "Alfuzosin (Uroxatral)", tone: "sympathetic", agonism: "antagonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["alpha-1"], receptorMap: { "alpha-1": { mode: "direct" } }, explanation: "A uroselective alpha-1 antagonist for BPH that is less likely to cause hypotension." },
                { name: "Silodosin (Rapaflo)", tone: "sympathetic", agonism: "antagonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["alpha-1"], receptorMap: { "alpha-1": { mode: "direct" } }, explanation: "A highly selective alpha-1A antagonist for BPH, associated with ejaculatory dysfunction." },
                { name: "Yohimbine", tone: "sympathetic", agonism: "antagonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["alpha-2"], receptorMap: { "alpha-2": { mode: "direct" } }, tiltOverride: "fight", explanation: "A selective alpha-2 antagonist that blocks presynaptic feedback inhibition, increasing sympathetic outflow and blood pressure." },
                { name: "Propranolol", tone: "sympathetic", agonism: "antagonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["beta-1", "beta-2"], receptorMap: { "beta-1": { mode: "direct" }, "beta-2": { mode: "direct" } }, explanation: "A non-selective beta-antagonist (prototype) that reduces heart rate, contractility, and blood pressure." },
                { name: "Nadolol", tone: "sympathetic", agonism: "antagonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["beta-1", "beta-2"], receptorMap: { "beta-1": { mode: "direct" }, "beta-2": { mode: "direct" } }, explanation: "A long-acting, non-selective beta-blocker." },
                { name: "Timolol", tone: "sympathetic", agonism: "antagonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["beta-1", "beta-2"], receptorMap: { "beta-1": { mode: "direct" }, "beta-2": { mode: "direct" } }, explanation: "A non-selective beta-blocker used topically to treat glaucoma by reducing aqueous humor production." },
                { name: "Pindolol", tone: "sympathetic", agonism: "antagonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["beta-1", "beta-2"], receptorMap: { "beta-1": { mode: "direct" }, "beta-2": { mode: "direct" } }, explanation: "A non-selective beta-blocker with intrinsic sympathomimetic activity (ISA), causing less bradycardia at rest." },
                { name: "Carteolol", tone: "sympathetic", agonism: "antagonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["beta-1", "beta-2"], receptorMap: { "beta-1": { mode: "direct" }, "beta-2": { mode: "direct" } }, explanation: "A non-selective beta-blocker with intrinsic sympathomimetic activity (ISA)." },
                { name: "Penbutolol", tone: "sympathetic", agonism: "antagonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["beta-1", "beta-2"], receptorMap: { "beta-1": { mode: "direct" }, "beta-2": { mode: "direct" } }, explanation: "A non-selective beta-blocker with intrinsic sympathomimetic activity (ISA)." },
                { name: "Metoprolol", tone: "sympathetic", agonism: "antagonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["beta-1"], receptorMap: { "beta-1": { mode: "direct" } }, explanation: "A cardioselective (beta-1) antagonist that primarily reduces heart rate and contractility." },
                { name: "Atenolol", tone: "sympathetic", agonism: "antagonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["beta-1"], receptorMap: { "beta-1": { mode: "direct" } }, explanation: "A cardioselective (beta-1) antagonist, similar to metoprolol but more water-soluble with less CNS penetration." },
                { name: "Esmolol", tone: "sympathetic", agonism: "antagonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["beta-1"], receptorMap: { "beta-1": { mode: "direct" } }, explanation: "An ultra-short-acting, intravenous, cardioselective (beta-1) antagonist." },
                { name: "Acebutolol", tone: "sympathetic", agonism: "antagonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["beta-1"], receptorMap: { "beta-1": { mode: "direct" } }, explanation: "A cardioselective (beta-1) blocker with intrinsic sympathomimetic activity (ISA)." },
                { name: "Labetalol", tone: "sympathetic", agonism: "antagonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["alpha-1", "beta-1", "beta-2"], receptorMap: { "alpha-1": { mode: "direct" }, "beta-1": { mode: "direct" }, "beta-2": { mode: "direct" } }, explanation: "A mixed antagonist blocking alpha-1, beta-1, and beta-2 receptors, causing vasodilation and reduced heart rate." },
                { name: "Carvedilol (Coreg)", tone: "sympathetic", agonism: "antagonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["alpha-1", "beta-1", "beta-2"], receptorMap: { "alpha-1": { mode: "direct" }, "beta-1": { mode: "direct" }, "beta-2": { mode: "direct" } }, explanation: "A mixed alpha/beta antagonist with antioxidant properties, commonly used in heart failure." },
                { name: "Nebivolol (Bystolic)", tone: "sympathetic", agonism: "antagonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["beta-1"], receptorMap: { "beta-1": { mode: "direct" } }, explanation: "A highly selective beta-1 blocker that also causes vasodilation by releasing nitric oxide." },
                { name: "Reserpine", tone: "sympathetic", agonism: "antagonist", actionPaths: ["indirect"], indirectMechanisms: ["Other"], receptors: [], receptorMap: {}, explanation: "Depletes norepinephrine from nerve terminals by irreversibly blocking the vesicular monoamine transporter (VMAT)." },
                { name: "Guanethidine", tone: "sympathetic", agonism: "antagonist", actionPaths: ["indirect"], indirectMechanisms: ["Other"], receptors: [], receptorMap: {}, explanation: "Inhibits the release of norepinephrine from sympathetic nerve endings." },
                { name: "Bretylium", tone: "sympathetic", agonism: "antagonist", actionPaths: ["indirect"], indirectMechanisms: ["Other"], receptors: [], receptorMap: {}, explanation: "Blocks the release of norepinephrine from nerve terminals; formerly used as an antiarrhythmic." },

                // --- PARASYMPATHOMIMETICS (Cholinergic Agonists) ---
                { name: "Acetylcholine", tone: "parasympathetic", agonism: "agonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["M1", "M2", "M3"], receptorMap: { "M1": { mode: "direct" }, "M2": { mode: "direct" }, "M3": { mode: "direct" } }, explanation: "The endogenous neurotransmitter for muscarinic and nicotinic receptors; very short-acting." },
                { name: "Muscarine", tone: "parasympathetic", agonism: "agonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["M1", "M2", "M3"], receptorMap: { "M1": { mode: "direct" }, "M2": { mode: "direct" }, "M3": { mode: "direct" } }, explanation: "Natural alkaloid from mushrooms that is a potent, selective muscarinic receptor agonist." },
                { name: "Arecoline", tone: "parasympathetic", agonism: "agonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["M1", "M2", "M3"], receptorMap: { "M1": { mode: "direct" }, "M2": { mode: "direct" }, "M3": { mode: "direct" } }, explanation: "An alkaloid from the betel nut that acts as a muscarinic agonist." },
                { name: "Bethanechol (Urecholine)", tone: "parasympathetic", agonism: "agonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["M2", "M3"], receptorMap: { "M2": { mode: "direct" }, "M3": { mode: "direct" } }, explanation: "A muscarinic agonist resistant to cholinesterases; used to stimulate bladder and GI smooth muscle." },
                { name: "Carbachol", tone: "parasympathetic", agonism: "agonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["M1", "M2", "M3"], receptorMap: { "M1": { mode: "direct" }, "M2": { mode: "direct" }, "M3": { mode: "direct" } }, explanation: "A potent muscarinic and nicotinic agonist, primarily used as a miotic agent in ophthalmology." },
                { name: "Methacholine", tone: "parasympathetic", agonism: "agonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["M3"], receptorMap: { "M3": { mode: "direct" } }, explanation: "A muscarinic agonist primarily acting on M3 receptors, used in the bronchial challenge test to diagnose asthma." },
                { name: "Pilocarpine", tone: "parasympathetic", agonism: "agonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["M1", "M2", "M3"], receptorMap: { "M1": { mode: "direct" }, "M2": { mode: "direct" }, "M3": { mode: "direct" } }, explanation: "A muscarinic agonist used to treat glaucoma (miosis) and xerostomia (dry mouth)." },
                { name: "Neostigmine", tone: "parasympathetic", agonism: "agonist", actionPaths: ["indirect"], indirectMechanisms: ["AChE inhibition"], receptors: ["M1", "M2", "M3"], receptorMap: { "M1": { mode: "indirect", mechanisms: ["AChE inhibition"] }, "M2": { mode: "indirect", mechanisms: ["AChE inhibition"] }, "M3": { mode: "indirect", mechanisms: ["AChE inhibition"] } }, explanation: "A quaternary amine reversible AChE inhibitor; does not cross the BBB. Used for myasthenia gravis and reversal of neuromuscular blockade." },
                { name: "Pyridostigmine", tone: "parasympathetic", agonism: "agonist", actionPaths: ["indirect"], indirectMechanisms: ["AChE inhibition"], receptors: ["M1", "M2", "M3"], receptorMap: { "M1": { mode: "indirect", mechanisms: ["AChE inhibition"] }, "M2": { mode: "indirect", mechanisms: ["AChE inhibition"] }, "M3": { mode: "indirect", mechanisms: ["AChE inhibition"] } }, explanation: "A longer-acting reversible AChE inhibitor used for chronic management of myasthenia gravis." },
                { name: "Physostigmine", tone: "parasympathetic", agonism: "agonist", actionPaths: ["indirect"], indirectMechanisms: ["AChE inhibition"], receptors: ["M1", "M2", "M3"], receptorMap: { "M1": { mode: "indirect", mechanisms: ["AChE inhibition"] }, "M2": { mode: "indirect", mechanisms: ["AChE inhibition"] }, "M3": { mode: "indirect", mechanisms: ["AChE inhibition"] } }, explanation: "A tertiary amine reversible AChE inhibitor that crosses the BBB. Used as an antidote for anticholinergic toxicity." },
                { name: "Edrophonium", tone: "parasympathetic", agonism: "agonist", actionPaths: ["indirect"], indirectMechanisms: ["AChE inhibition"], receptors: ["M1", "M2", "M3"], receptorMap: { "M1": { mode: "indirect", mechanisms: ["AChE inhibition"] }, "M2": { mode: "indirect", mechanisms: ["AChE inhibition"] }, "M3": { mode: "indirect", mechanisms: ["AChE inhibition"] } }, explanation: "A very short-acting, reversible AChE inhibitor historically used for diagnosing myasthenia gravis (Tensilon test)." },
                { name: "Ambenonium", tone: "parasympathetic", agonism: "agonist", actionPaths: ["indirect"], indirectMechanisms: ["AChE inhibition"], receptors: ["M1", "M2", "M3"], receptorMap: { "M1": { mode: "indirect", mechanisms: ["AChE inhibition"] }, "M2": { mode: "indirect", mechanisms: ["AChE inhibition"] }, "M3": { mode: "indirect", mechanisms: ["AChE inhibition"] } }, explanation: "A reversible AChE inhibitor used for treating myasthenia gravis." },
                { name: "Rivastigmine", tone: "parasympathetic", agonism: "agonist", actionPaths: ["indirect"], indirectMechanisms: ["AChE inhibition"], receptors: ["M1", "M2", "M3"], receptorMap: { "M1": { mode: "indirect", mechanisms: ["AChE inhibition"] }, "M2": { mode: "indirect", mechanisms: ["AChE inhibition"] }, "M3": { mode: "indirect", mechanisms: ["AChE inhibition"] } }, explanation: "A centrally-acting AChE inhibitor that crosses the BBB, used for dementia associated with Alzheimer's and Parkinson's disease." },
                { name: "Donepezil", tone: "parasympathetic", agonism: "agonist", actionPaths: ["indirect"], indirectMechanisms: ["AChE inhibition"], receptors: ["M1", "M2", "M3"], receptorMap: { "M1": { mode: "indirect", mechanisms: ["AChE inhibition"] }, "M2": { mode: "indirect", mechanisms: ["AChE inhibition"] }, "M3": { mode: "indirect", mechanisms: ["AChE inhibition"] } }, explanation: "A centrally-acting, reversible AChE inhibitor used to improve cognition in Alzheimer's disease." },
                { name: "Tacrine", tone: "parasympathetic", agonism: "agonist", actionPaths: ["indirect"], indirectMechanisms: ["AChE inhibition"], receptors: ["M1", "M2", "M3"], receptorMap: { "M1": { mode: "indirect", mechanisms: ["AChE inhibition"] }, "M2": { mode: "indirect", mechanisms: ["AChE inhibition"] }, "M3": { mode: "indirect", mechanisms: ["AChE inhibition"] } }, explanation: "The first centrally-acting AChE inhibitor approved for Alzheimer's, now rarely used due to hepatotoxicity." },
                { name: "Echothiophate", tone: "parasympathetic", agonism: "agonist", actionPaths: ["indirect"], indirectMechanisms: ["AChE inhibition"], receptors: ["M1", "M2", "M3"], receptorMap: { "M1": { mode: "indirect", mechanisms: ["AChE inhibition"] }, "M2": { mode: "indirect", mechanisms: ["AChE inhibition"] }, "M3": { mode: "indirect", mechanisms: ["AChE inhibition"] } }, explanation: "An irreversible organophosphate AChE inhibitor, causing long-lasting effects. Used topically for glaucoma." },
                { name: "Isoflurophate", tone: "parasympathetic", agonism: "agonist", actionPaths: ["indirect"], indirectMechanisms: ["AChE inhibition"], receptors: ["M1", "M2", "M3"], receptorMap: { "M1": { mode: "indirect", mechanisms: ["AChE inhibition"] }, "M2": { mode: "indirect", mechanisms: ["AChE inhibition"] }, "M3": { mode: "indirect", mechanisms: ["AChE inhibition"] } }, explanation: "An irreversible organophosphate AChE inhibitor used in ophthalmic ointments." },
                { name: "Malathion", tone: "parasympathetic", agonism: "agonist", actionPaths: ["indirect"], indirectMechanisms: ["AChE inhibition"], receptors: ["M1", "M2", "M3"], receptorMap: { "M1": { mode: "indirect", mechanisms: ["AChE inhibition"] }, "M2": { mode: "indirect", mechanisms: ["AChE inhibition"] }, "M3": { mode: "indirect", mechanisms: ["AChE inhibition"] } }, explanation: "An organophosphate insecticide and irreversible AChE inhibitor; a common source of cholinergic toxicity." },
                { name: "Parathion", tone: "parasympathetic", agonism: "agonist", actionPaths: ["indirect"], indirectMechanisms: ["AChE inhibition"], receptors: ["M1", "M2", "M3"], receptorMap: { "M1": { mode: "indirect", mechanisms: ["AChE inhibition"] }, "M2": { mode: "indirect", mechanisms: ["AChE inhibition"] }, "M3": { mode: "indirect", mechanisms: ["AChE inhibition"] } }, explanation: "A highly toxic organophosphate insecticide and irreversible AChE inhibitor." },
                { name: "Sarin (GB)", tone: "parasympathetic", agonism: "agonist", actionPaths: ["indirect"], indirectMechanisms: ["AChE inhibition"], receptors: ["M1", "M2", "M3"], receptorMap: { "M1": { mode: "indirect", mechanisms: ["AChE inhibition"] }, "M2": { mode: "indirect", mechanisms: ["AChE inhibition"] }, "M3": { mode: "indirect", mechanisms: ["AChE inhibition"] } }, explanation: "A highly toxic organophosphate nerve agent and irreversible AChE inhibitor." },
                { name: "Soman (GD)", tone: "parasympathetic", agonism: "agonist", actionPaths: ["indirect"], indirectMechanisms: ["AChE inhibition"], receptors: ["M1", "M2", "M3"], receptorMap: { "M1": { mode: "indirect", mechanisms: ["AChE inhibition"] }, "M2": { mode: "indirect", mechanisms: ["AChE inhibition"] }, "M3": { mode: "indirect", mechanisms: ["AChE inhibition"] } }, explanation: "A highly toxic organophosphate nerve agent and irreversible AChE inhibitor, known for rapid 'aging'." },
                { name: "Tabun (GA)", tone: "parasympathetic", agonism: "agonist", actionPaths: ["indirect"], indirectMechanisms: ["AChE inhibition"], receptors: ["M1", "M2", "M3"], receptorMap: { "M1": { mode: "indirect", mechanisms: ["AChE inhibition"] }, "M2": { mode: "indirect", mechanisms: ["AChE inhibition"] }, "M3": { mode: "indirect", mechanisms: ["AChE inhibition"] } }, explanation: "A highly toxic organophosphate nerve agent and irreversible AChE inhibitor." },
                { name: "VX", tone: "parasympathetic", agonism: "agonist", actionPaths: ["indirect"], indirectMechanisms: ["AChE inhibition"], receptors: ["M1", "M2", "M3"], receptorMap: { "M1": { mode: "indirect", mechanisms: ["AChE inhibition"] }, "M2": { mode: "indirect", mechanisms: ["AChE inhibition"] }, "M3": { mode: "indirect", mechanisms: ["AChE inhibition"] } }, explanation: "An extremely potent and persistent organophosphate nerve agent and irreversible AChE inhibitor." },

                // --- PARASYMPATHOLYTICS (Cholinergic Antagonists) ---
                { name: "Atropine", tone: "parasympathetic", agonism: "antagonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["M1", "M2", "M3"], receptorMap: { "M1": { mode: "direct" }, "M2": { mode: "direct" }, "M3": { mode: "direct" } }, explanation: "A non-selective muscarinic antagonist prototype. Used for bradycardia, reducing secretions, and as an antidote for cholinergic poisoning." },
                { name: "Scopolamine (Hyoscine)", tone: "parasympathetic", agonism: "antagonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["M1", "M2", "M3"], receptorMap: { "M1": { mode: "direct" }, "M2": { mode: "direct" }, "M3": { mode: "direct" } }, explanation: "A muscarinic antagonist with more pronounced CNS effects than atropine. Used for motion sickness and sedation." },
                { name: "Glycopyrrolate (Robinul)", tone: "parasympathetic", agonism: "antagonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["M1", "M2", "M3"], receptorMap: { "M1": { mode: "direct" }, "M2": { mode: "direct" }, "M3": { mode: "direct" } }, explanation: "A quaternary amine muscarinic antagonist that does not cross the BBB. Used to reduce secretions." },
                { name: "Ipratropium (Atrovent)", tone: "parasympathetic", agonism: "antagonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["M1", "M2", "M3"], receptorMap: { "M1": { mode: "direct" }, "M2": { mode: "direct" }, "M3": { mode: "direct" } }, explanation: "An inhaled short-acting muscarinic antagonist (SAMA) causing bronchodilation, primarily for COPD." },
                { name: "Tiotropium (Spiriva)", tone: "parasympathetic", agonism: "antagonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["M1", "M3"], receptorMap: { "M1": { mode: "direct" }, "M3": { mode: "direct" } }, explanation: "An inhaled long-acting muscarinic antagonist (LAMA) with kinetic selectivity for M3 over M2, for sustained bronchodilation." },
                { name: "Aclidinium (Tudorza)", tone: "parasympathetic", agonism: "antagonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["M3"], receptorMap: { "M3": { mode: "direct" } }, explanation: "An inhaled long-acting muscarinic antagonist (LAMA) used for maintenance therapy in COPD." },
                { name: "Umeclidinium (Incruse)", tone: "parasympathetic", agonism: "antagonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["M3"], receptorMap: { "M3": { mode: "direct" } }, explanation: "An inhaled long-acting muscarinic antagonist (LAMA) used in combination products for COPD." },
                { name: "Benztropine (Cogentin)", tone: "parasympathetic", agonism: "antagonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["M1"], receptorMap: { "M1": { mode: "direct" } }, explanation: "A centrally-acting M1 antagonist for Parkinsonism and drug-induced extrapyramidal symptoms." },
                { name: "Trihexyphenidyl (Artane)", tone: "parasympathetic", agonism: "antagonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["M1"], receptorMap: { "M1": { mode: "direct" } }, explanation: "A centrally-acting M1 antagonist, similar to benztropine, for Parkinson's disease." },
                { name: "Oxybutynin (Ditropan)", tone: "parasympathetic", agonism: "antagonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["M3"], receptorMap: { "M3": { mode: "direct" } }, explanation: "A muscarinic antagonist, primarily targeting M3 receptors, to treat overactive bladder." },
                { name: "Tolterodine (Detrol)", tone: "parasympathetic", agonism: "antagonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["M2", "M3"], receptorMap: { "M2": { mode: "direct" }, "M3": { mode: "direct" } }, explanation: "A competitive muscarinic antagonist for overactive bladder, with more selectivity for the bladder than salivary glands compared to oxybutynin." },
                { name: "Fesoterodine (Toviaz)", tone: "parasympathetic", agonism: "antagonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["M2", "M3"], receptorMap: { "M2": { mode: "direct" }, "M3": { mode: "direct" } }, explanation: "A competitive muscarinic antagonist prodrug, similar to tolterodine, for overactive bladder." },
                { name: "Darifenacin (Enablex)", tone: "parasympathetic", agonism: "antagonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["M3"], receptorMap: { "M3": { mode: "direct" } }, explanation: "A highly selective M3 muscarinic antagonist used for treating overactive bladder." },
                { name: "Solifenacin (Vesicare)", tone: "parasympathetic", agonism: "antagonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["M3"], receptorMap: { "M3": { mode: "direct" } }, explanation: "A competitive muscarinic antagonist with selectivity for the M3 receptor, used for overactive bladder." },
                { name: "Trospium (Sanctura)", tone: "parasympathetic", agonism: "antagonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["M2", "M3"], receptorMap: { "M2": { mode: "direct" }, "M3": { mode: "direct" } }, explanation: "A quaternary amine muscarinic antagonist for overactive bladder; does not cross the BBB." },
                { name: "Tropicamide", tone: "parasympathetic", agonism: "antagonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["M3"], receptorMap: { "M3": { mode: "direct" } }, explanation: "A short-acting muscarinic antagonist used topically to induce mydriasis and cycloplegia for eye exams." },
                { name: "Cyclopentolate", tone: "parasympathetic", agonism: "antagonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["M3"], receptorMap: { "M3": { mode: "direct" } }, explanation: "A muscarinic antagonist used topically for mydriasis and cycloplegia with a longer duration than tropicamide." },
                { name: "Propantheline (Pro-Banthine)", tone: "parasympathetic", agonism: "antagonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["M1", "M2", "M3"], receptorMap: { "M1": { mode: "direct" }, "M2": { mode: "direct" }, "M3": { mode: "direct" } }, explanation: "A muscarinic antagonist formerly used for peptic ulcer disease and GI hypermotility." },
                { name: "Diphenhydramine (Benadryl)", tone: "parasympathetic", agonism: "antagonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["M1", "M2", "M3"], receptorMap: { "M1": { mode: "direct" }, "M2": { mode: "direct" }, "M3": { mode: "direct" } }, explanation: "A first-generation antihistamine with significant anticholinergic (muscarinic antagonist) properties." },
                { name: "Imipramine", tone: "parasympathetic", agonism: "antagonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["M1", "M2", "M3"], receptorMap: { "M1": { mode: "direct" }, "M2": { mode: "direct" }, "M3": { mode: "direct" } }, explanation: "A tricyclic antidepressant with strong anticholinergic side effects; also blocks reuptake of norepinephrine and serotonin." },
                { name: "Amitriptyline", tone: "parasympathetic", agonism: "antagonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["M1", "M2", "M3"], receptorMap: { "M1": { mode: "direct" }, "M2": { mode: "direct" }, "M3": { mode: "direct" } }, explanation: "A tricyclic antidepressant with strong anticholinergic (muscarinic antagonist) side effects." },
                { name: "Thioridazine", tone: "parasympathetic", agonism: "antagonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["M1", "M2", "M3"], receptorMap: { "M1": { mode: "direct" }, "M2": { mode: "direct" }, "M3": { mode: "direct" } }, explanation: "A typical antipsychotic with strong anticholinergic (muscarinic antagonist) properties." },
                { name: "Metoclopramide (Reglan)", tone: "parasympathetic", agonism: "agonist", actionPaths: ["indirect"], indirectMechanisms: ["Other"], receptors: ["M1", "M2", "M3"], receptorMap: { "M1": { mode: "indirect", mechanisms: ["Other"] }, "M2": { mode: "indirect", mechanisms: ["Other"] }, "M3": { mode: "indirect", mechanisms: ["Other"] } }, explanation: "Primarily a D2 antagonist, but also acts as a prokinetic by promoting acetylcholine release in the GI tract." },

                // --- GANGLIONIC & NMJ AGENTS ---
                { name: "Nicotine", tone: "ganglionic", agonism: "agonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["Nn", "Nm"], receptorMap: { "Nn": { mode: "direct" }, "Nm": { mode: "direct" } }, tiltOverride: "variable", explanation: "A nicotinic receptor agonist that stimulates both sympathetic and parasympathetic ganglia (Nn) and the neuromuscular junction (Nm)." },
                { name: "Hexamethonium", tone: "ganglionic", agonism: "antagonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["Nn"], receptorMap: { "Nn": { mode: "direct" } }, tiltOverride: "variable", explanation: "A non-depolarizing ganglionic blocker that antagonizes nicotinic (Nn) receptors in both autonomic ganglia." },
                { name: "Mecamylamine", tone: "ganglionic", agonism: "antagonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["Nn"], receptorMap: { "Nn": { mode: "direct" } }, tiltOverride: "variable", explanation: "A non-competitive ganglionic blocker that antagonizes nicotinic (Nn) receptors." },
                { name: "Trimethaphan", tone: "ganglionic", agonism: "antagonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["Nn"], receptorMap: { "Nn": { mode: "direct" } }, tiltOverride: "variable", explanation: "A short-acting ganglionic blocker used for controlled hypotension." },
                { name: "Pancuronium", tone: "ganglionic", agonism: "antagonist", actionPaths: ["direct"], indirectMechanisms: [], receptors: ["Nm"], receptorMap: { "Nm": { mode: "direct" } }, tiltOverride: "variable", explanation: "A non-depolarizing neuromuscular blocker that antagonizes nicotinic (Nm) receptors at the NMJ." },
            ];

            const allReceptors = ["alpha-1", "alpha-2", "beta-1", "beta-2", "beta-3", "M1", "M2", "M3", "M4", "M5", "Nn", "Nm"];

            // --- STATE --- //
            let state = {
                currentDrug: null,
                mode: 'minimal',
                session: 'study',
                isFlipped: false,
                testCycleCount: 0,
                missedInTest: [],
                questionBank: [],
                masteredBank: [],
            };

            // --- DOM ELEMENTS --- //
            const DOMElements = {
                flipCard: document.getElementById('flip-card'),
                drugNameFront: document.getElementById('drug-name-front'),
                drugNameBack: document.getElementById('drug-name-back'),
                quizForm: document.getElementById('quiz-form'),
                receptorsGroup: document.getElementById('receptors-group'),
                indirectMechContainer: document.getElementById('indirect-mechanisms-container'),
                submitBtn: document.getElementById('submit-btn'),
                resetBtn: document.getElementById('reset-btn'),
                backBtn: document.getElementById('back-btn'),
                nextBtn: document.getElementById('next-btn'),
                feedbackSection: document.getElementById('feedback-section'),
                explanation: document.getElementById('explanation'),
                explanationText: document.getElementById('explanation-text'),
                scoreboard: document.getElementById('scoreboard'),
                modeToggle: document.getElementById('mode-toggle'),
                sessionToggle: document.getElementById('session-toggle'),
                modeChooserModal: document.getElementById('mode-chooser-modal'),
                chooseMinimalBtn: document.getElementById('choose-minimal'),
                chooseAdvancedBtn: document.getElementById('choose-advanced'),
                testResultsModal: document.getElementById('test-results-modal'),
                testResultsContent: document.getElementById('test-results-content'),
                closeResultsBtn: document.getElementById('close-results-btn'),
            };

            // --- HELPER FUNCTIONS --- //

            const shuffleArray = (array) => {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            };

            const calculateTilt = (drug) => {
                if (drug.tiltOverride) return drug.tiltOverride;
                if (drug.tone === 'sympathetic') {
                    return drug.agonism === 'agonist' ? 'fight' : 'rest';
                } else { // parasympathetic
                    return drug.agonism === 'agonist' ? 'rest' : 'fight';
                }
            };
            
            const arrayEquals = (a, b) => {
                return Array.isArray(a) && Array.isArray(b) && a.length === b.length && a.sort().every((val, index) => val === b.sort()[index]);
            }

            const updateScoreboard = () => {
                 const mastered = state.masteredBank.length;
                 const remaining = state.questionBank.length;
                 DOMElements.scoreboard.textContent = `Mastered: ${mastered} | Remaining: ${remaining}`;
            };
            
            const flipCard = () => {
                state.isFlipped = !state.isFlipped;
                DOMElements.flipCard.classList.toggle('is-flipped', state.isFlipped);
            };

            // --- CORE LOGIC --- //
            
            const initializeQuiz = () => {
                state.questionBank = [...masterDrugList];
                shuffleArray(state.questionBank);
                state.masteredBank = [];
                state.testCycleCount = 0;
                state.missedInTest = [];
                loadNewCard();
            };

            const populateReceptors = () => {
                DOMElements.receptorsGroup.innerHTML = '';
                allReceptors.forEach(receptor => {
                    const receptorId = `receptor-${receptor.replace('-','')}`;
                    let html = `
                        <div style="display: flex; flex-direction: column; align-items: center;">
                           <input type="checkbox" id="${receptorId}" name="receptor" value="${receptor}" class="choice-input">
                           <label for="${receptorId}" class="choice-label">${receptor}</label>
                           <div id="details-${receptorId}" class="receptor-details hidden">
                               <div class="toggle-switch">
                                   <button data-value="direct" data-receptor="${receptor}" class="active">Direct</button>
                                   <button data-value="indirect" data-receptor="${receptor}">Indirect</button>
                               </div>
                           </div>
                        </div>`;
                    DOMElements.receptorsGroup.insertAdjacentHTML('beforeend', html);
                });

                // Add event listeners for advanced mode toggles
                 DOMElements.receptorsGroup.querySelectorAll('input[name="receptor"]').forEach(checkbox => {
                    checkbox.addEventListener('change', () => {
                        if (state.mode === 'advanced') {
                            const detailsDiv = document.getElementById(`details-${checkbox.id}`);
                            detailsDiv.classList.toggle('hidden', !checkbox.checked);
                        }
                    });
                });

                DOMElements.receptorsGroup.querySelectorAll('.receptor-details .toggle-switch button').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                         e.preventDefault();
                         const parent = e.target.parentElement;
                         parent.querySelector('.active').classList.remove('active');
                         e.target.classList.add('active');
                    });
                });
            };

            const resetCard = () => {
                DOMElements.quizForm.reset();
                if (state.isFlipped) flipCard();
                DOMElements.feedbackSection.innerHTML = '';
                DOMElements.explanation.classList.add('hidden');
                DOMElements.indirectMechContainer.classList.add('hidden');
                
                document.querySelectorAll('.choice-input').forEach(input => input.checked = false);
                
                if (state.mode === 'advanced') {
                    document.querySelectorAll('.receptor-details').forEach(el => el.classList.add('hidden'));
                }
            };

            const loadNewCard = () => {
                if (state.questionBank.length === 0) {
                    if (state.masteredBank.length > 0) {
                        // All questions answered correctly, cycle them back in
                        state.questionBank = [...state.masteredBank];
                        state.masteredBank = [];
                        shuffleArray(state.questionBank);
                    } else {
                        // This case should ideally not be hit if masterDrugList is not empty
                        DOMElements.drugNameFront.textContent = "Quiz Complete!";
                        DOMElements.quizForm.classList.add('hidden');
                        return;
                    }
                }
                
                DOMElements.quizForm.classList.remove('hidden');
                state.currentDrug = state.questionBank[0]; // Always take the next question from the front
                resetCard();
                DOMElements.drugNameFront.textContent = state.currentDrug.name;
                DOMElements.drugNameBack.textContent = state.currentDrug.name;
                DOMElements.explanationText.textContent = state.currentDrug.explanation;
                updateScoreboard();
            };

            const gradeAnswer = () => {
                const drug = state.currentDrug;
                const formData = new FormData(DOMElements.quizForm);
                const results = { isFullyCorrect: true, feedback: {} };
                
                const userPathway = formData.get('pathway');
                results.feedback.pathway = { correct: userPathway === drug.tone, user: userPathway || 'None', answer: drug.tone };
                if (!results.feedback.pathway.correct) results.isFullyCorrect = false;

                const userAgonism = formData.get('agonism');
                results.feedback.agonism = { correct: userAgonism === drug.agonism, user: userAgonism || 'None', answer: drug.agonism };
                if (!results.feedback.agonism.correct) results.isFullyCorrect = false;
                
                const userTilt = formData.get('tilt');
                const correctTilt = calculateTilt(drug);
                
                const tiltMap = { fight: 'Fight-or-Flight', rest: 'Rest-and-Digest', variable: 'Variable' };
                results.feedback.tilt = { correct: userTilt === correctTilt, user: userTilt ? tiltMap[userTilt] : 'None', answer: tiltMap[correctTilt] };
                if (!results.feedback.tilt.correct) results.isFullyCorrect = false;
                
                const userActionPaths = formData.getAll('actionPath');
                results.feedback.actionPath = { correct: arrayEquals(userActionPaths.sort(), drug.actionPaths.sort()), user: userActionPaths.length > 0 ? userActionPaths.join(', ') : 'None', answer: drug.actionPaths.join(', ') };
                if (!results.feedback.actionPath.correct) results.isFullyCorrect = false;

                const userMechanisms = formData.getAll('indirectMechanism');
                const requiresMechanisms = drug.actionPaths.includes('indirect');
                let mechanismsCorrect = false;
                if (requiresMechanisms) {
                    mechanismsCorrect = arrayEquals(userMechanisms.sort(), drug.indirectMechanisms.sort());
                } else {
                    mechanismsCorrect = userMechanisms.length === 0;
                }
                results.feedback.mechanisms = { correct: mechanismsCorrect, user: userMechanisms.length > 0 ? userMechanisms.join(', ') : 'None', answer: drug.indirectMechanisms.length > 0 ? drug.indirectMechanisms.join(', ') : 'None' };
                if (!results.feedback.mechanisms.correct) results.isFullyCorrect = false;

                const userReceptors = formData.getAll('receptor');
                const correctReceptors = state.mode === 'minimal' ? drug.receptors : Object.keys(drug.receptorMap);
                const incorrectSelections = userReceptors.filter(r => !correctReceptors.includes(r));
                const missedSelections = correctReceptors.filter(r => !userReceptors.includes(r));
                let receptorsCorrect = incorrectSelections.length === 0 && missedSelections.length === 0;
                results.feedback.receptors = { correct: receptorsCorrect, correctChips: userReceptors.filter(r => correctReceptors.includes(r)), incorrectChips: incorrectSelections, missedChips: missedSelections, advancedFeedback: {} };

                if (state.mode === 'advanced') {
                    let allAdvancedCorrect = true;
                    if (correctReceptors.length > 0) { // Only grade if there are receptors to grade
                        for (const receptor of correctReceptors) {
                             if (!userReceptors.includes(receptor)) {
                                 allAdvancedCorrect = false; continue;
                             }
                            const answer = drug.receptorMap[receptor];
                            const detailsDiv = document.getElementById(`details-receptor-${receptor.replace('-','')}`);
                            const userMode = detailsDiv.querySelector('.toggle-switch .active').dataset.value;
                            let modeCorrect = (answer.mode === 'both') || (userMode === answer.mode);
                            if (!modeCorrect) allAdvancedCorrect = false;
                            results.feedback.receptors.advancedFeedback[receptor] = { correct: modeCorrect, user: userMode, answer: answer.mode };
                        }
                    } else if (userReceptors.length > 0) { // User selected receptors when none were correct
                         allAdvancedCorrect = false;
                    }

                    if (!allAdvancedCorrect) receptorsCorrect = false;
                    results.feedback.receptors.correct = receptorsCorrect;
                }

                if (!receptorsCorrect) results.isFullyCorrect = false;
                
                return results;
            };

            const displayFeedback = (results) => {
                DOMElements.feedbackSection.innerHTML = '';
                const createRow = (label, value, isCorrect) => `<div class="feedback-row ${isCorrect ? 'correct' : 'incorrect'}"><div class="label">${label}</div><div class="value">${value}</div></div>`;
                const createChip = (text, type) => `<div class="chip ${type}">${text}</div>`;

                DOMElements.feedbackSection.insertAdjacentHTML('beforeend', createRow('Pathway', results.feedback.pathway.user, results.feedback.pathway.correct));
                DOMElements.feedbackSection.insertAdjacentHTML('beforeend', createRow('Action Path', results.feedback.actionPath.user, results.feedback.actionPath.correct));
                DOMElements.feedbackSection.insertAdjacentHTML('beforeend', createRow('Agonism', results.feedback.agonism.user, results.feedback.agonism.correct));
                DOMElements.feedbackSection.insertAdjacentHTML('beforeend', createRow('Net Tilt', results.feedback.tilt.user, results.feedback.tilt.correct));
                
                if (state.currentDrug.actionPaths.includes('indirect') || results.feedback.mechanisms.user !== 'None') {
                     DOMElements.feedbackSection.insertAdjacentHTML('beforeend', createRow('Mechanisms', results.feedback.mechanisms.user, results.feedback.mechanisms.correct));
                }
                
                const receptorFb = results.feedback.receptors;
                let receptorChipsHTML = receptorFb.correctChips.map(r => createChip(r, 'correct')).join('');
                receptorChipsHTML += receptorFb.incorrectChips.map(r => createChip(r, 'incorrect')).join('');
                receptorChipsHTML += receptorFb.missedChips.map(r => createChip(r, 'missed')).join('');
                const correctReceptorsString = (state.mode === 'minimal' ? state.currentDrug.receptors : Object.keys(state.currentDrug.receptorMap)).join(', ');
                if (receptorFb.missedChips.length > 0 || receptorFb.incorrectChips.length > 0) {
                     receptorChipsHTML += `<div style="width: 100%; font-size: 0.8rem; margin-top: 0.5rem;"><strong>Correct Answer:</strong> ${ correctReceptorsString || 'None' }</div>`;
                }
                
                DOMElements.feedbackSection.insertAdjacentHTML('beforeend', createRow('Receptors', `<div class="feedback-chips">${receptorChipsHTML || 'None'}</div>`, receptorFb.correct));

                if(state.session === 'study' || !results.isFullyCorrect) {
                    DOMElements.explanation.classList.remove('hidden');
                }
            };
            
            const showTestResults = () => {
                DOMElements.testResultsContent.innerHTML = state.missedInTest
                    .map(item => `<div><strong>${item.name}:</strong> ${item.explanation}</div>`)
                    .join('<hr style="margin: 0.5rem 0; border-color: var(--border-color);">');
                DOMElements.testResultsModal.classList.add('visible');
            };

            // --- EVENT HANDLERS --- //

            DOMElements.quizForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (state.isFlipped) return;

                const results = gradeAnswer();
                const answeredDrug = state.questionBank.shift(); // Remove drug from front of queue

                if (results.isFullyCorrect) {
                    state.masteredBank.push(answeredDrug);
                } else {
                    state.questionBank.push(answeredDrug); // Add to back of queue if incorrect
                    if (state.session === 'test' && !state.missedInTest.some(d => d.name === answeredDrug.name)) {
                         state.missedInTest.push({ name: answeredDrug.name, explanation: answeredDrug.explanation });
                    }
                }
                
                state.testCycleCount++;
                updateScoreboard();
                displayFeedback(results);
                flipCard();

                if (state.session === 'test' && state.testCycleCount >= 10 && state.missedInTest.length > 0) {
                    setTimeout(showTestResults, 800);
                }
            });
            
            DOMElements.nextBtn.addEventListener('click', loadNewCard);
            DOMElements.backBtn.addEventListener('click', flipCard);
            DOMElements.resetBtn.addEventListener('click', () => DOMElements.quizForm.reset());

            DOMElements.quizForm.querySelector('#action-indirect').addEventListener('change', (e) => {
                DOMElements.indirectMechContainer.classList.toggle('hidden', !e.target.checked);
            });

            const setupToggle = (toggleEl, stateKey, callback) => {
                toggleEl.addEventListener('click', (e) => {
                    if (e.target.tagName === 'BUTTON') {
                        if(e.target.classList.contains('active')) return;
                        toggleEl.querySelector('.active').classList.remove('active');
                        e.target.classList.add('active');
                        state[stateKey] = e.target.dataset[stateKey];
                        if (callback) callback();
                    }
                });
            };
            setupToggle(DOMElements.modeToggle, 'mode', initializeQuiz);
            setupToggle(DOMElements.sessionToggle, 'session', initializeQuiz);

            DOMElements.chooseMinimalBtn.addEventListener('click', () => {
                state.mode = 'minimal';
                DOMElements.modeToggle.querySelector('[data-mode="minimal"]').classList.add('active');
                DOMElements.modeToggle.querySelector('[data-mode="advanced"]').classList.remove('active');
                DOMElements.modeChooserModal.classList.remove('visible');
                initializeQuiz();
            });
            DOMElements.chooseAdvancedBtn.addEventListener('click', () => {
                state.mode = 'advanced';
                DOMElements.modeToggle.querySelector('[data-mode="advanced"]').classList.add('active');
                DOMElements.modeToggle.querySelector('[data-mode="minimal"]').classList.remove('active');
                DOMElements.modeChooserModal.classList.remove('visible');
                initializeQuiz();
            });

            DOMElements.closeResultsBtn.addEventListener('click', () => {
                DOMElements.testResultsModal.classList.remove('visible');
                state.testCycleCount = 0;
                state.missedInTest = [];
            });

            window.addEventListener('keydown', (e) => {
                if (DOMElements.modeChooserModal.classList.contains('visible') || DOMElements.testResultsModal.classList.contains('visible')) return;
                
                if (e.key === 'Enter' && !state.isFlipped) DOMElements.submitBtn.click();
                if (e.key.toLowerCase() === 'n' && state.isFlipped) DOMElements.nextBtn.click();
                if (e.key.toLowerCase() === 'r' && !state.isFlipped) DOMElements.resetBtn.click();
                
                const clickElement = (selector) => {
                    const el = DOMElements.quizForm.querySelector(selector);
                    if(el) el.checked = !el.checked;
                };

                if (!state.isFlipped) {
                    switch(e.key) {
                        case '1': clickElement('#path-symp'); break;
                        case '2': clickElement('#path-para'); break;
                        case '3': clickElement('#path-gang'); break;
                        case '5': clickElement('#agonism-agonist'); break;
                        case '6': clickElement('#agonism-antagonist'); break;
                        case 'f': clickElement('#tilt-fight'); break;
                        case 'd': clickElement('#tilt-rest'); break;
                        case 'v': clickElement('#tilt-variable'); break;
                    }
                }
            });

            // --- INITIALIZATION --- //
            const init = () => {
                populateReceptors();
                // Don't load card until mode is chosen
            };

            init();
        });
    </script>
</body>
</html>
